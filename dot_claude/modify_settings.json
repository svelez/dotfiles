#!/usr/bin/env bash

# Use existing file in case there are some centrally managed settings
infile=$(cat)

# But handle the case where there isn't
if [[ -z "$infile" ]]; then
  infile='{}'
fi

# Make sure to use key helper
echo "$infile" | jq '
	.apiKeyHelper = "abstract_pass.sh anthropic/apiKey1" |
	.permissions.allow += [
		"Bash(cat:*)",
		"Bash(date:*)",
		"Bash(file:*)",
		"Bash(find:*)",
		"Bash(grep:*)",
		"Bash(head:*)",
		"Bash(ls:*)",
		"Bash(mkdir:*)",
		"Bash(pwd:*)",
		"Bash(rg:*)",
		"Bash(tail:*)",
		"Bash(wc:*)",
		"Bash(which:*)",
		"Bash(tree:*)",

		"Bash(git add:*)",
		"Bash(git bisect:*)",
		"Bash(git blame:*)",
		"Bash(git commit:*)",
		"Bash(git diff:*)",
		"Bash(git fetch:*)",
		"Bash(git grep:*)",
		"Bash(git log:*)",
		"Bash(git ls-remote:*)",
		"Bash(git merge:*)",
		"Bash(git pull:*)",
		"Bash(git remote show:*)",
		"Bash(git restore:*)",
		"Bash(git show:*)",
		"Bash(git status:*)",

		"Bash(gh issue list:*)",
		"Bash(gh issue view:*)",
		"Bash(gh pr checks:*)",
		"Bash(gh pr diff:*)",
		"Bash(gh pr list:*)",
		"Bash(gh pr view:*)",
		"Bash(gh repo list:*)",
		"Bash(gh repo view:*)",
		"Bash(gh status:*)",

		"Bash(bzl run //:gazelle)",
		"Bash(bzl test:*)",
		"Bash(rapid test:*)",

		"Bash(go test:*)",
		"Bash(go fmt:*)",
		"Bash(go vet:*)",
		"Bash(go build:*)",
		"Bash(go install:*)",
		"Bash(go mod:*)",

		"Bash(cargo build:*)",
		"Bash(cargo check:*)",
		"Bash(cargo clippy:*)",
		"Bash(cargo test:*)",

		"Bash(npm info:*)",
		"Bash(npm run build:*)",
		"Bash(npm run fmt:*)",
		"Bash(npm run lint:*)",
		"Bash(npm run test:*)",
		"Bash(npm test:*)",

		"WebFetch(domain:docs.anthropic.com)",
		"WebFetch(domain:docs.claude.com)",
		"WebFetch(domain:platform.openai.com)",

		"mcp__atlassian__atlassianUserInfo",
		"mcp__atlassian__getAccessibleAtlassianResources",
		"mcp__atlassian__getConfluenceSpaces",
		"mcp__atlassian__getConfluencePage",
		"mcp__atlassian__getPagesInConfluenceSpace",
		"mcp__atlassian__getConfluencePageFooterComments",
		"mcp__atlassian__getConfluencePageInlineComments",
		"mcp__atlassian__getConfluencePageDescendants",
		"mcp__atlassian__searchConfluenceUsingCql",
		"mcp__atlassian__getJiraIssue",
		"mcp__atlassian__getTransitionsForJiraIssue",
		"mcp__atlassian__lookupJiraAccountId",
		"mcp__atlassian__searchJiraIssuesUsingJql",
		"mcp__atlassian__getJiraIssueRemoteIssueLinks",
		"mcp__atlassian__getVisibleJiraProjects",
		"mcp__atlassian__getJiraProjectIssueTypesMetadata",
		"mcp__atlassian__getJiraIssueTypeMetaWithFields",
		"mcp__atlassian__search",
		"mcp__atlassian__fetch",

		"mcp__datadog__aggregate_datadog_ci_pipeline_events",
		"mcp__datadog__aggregate_datadog_test_events",
		"mcp__datadog__analyze_datadog_logs",
		"mcp__datadog__get_datadog_flaky_tests",
		"mcp__datadog__get_datadog_incident",
		"mcp__datadog__get_datadog_metric",
		"mcp__datadog__get_datadog_metric_context",
		"mcp__datadog__get_datadog_notebook",
		"mcp__datadog__get_datadog_trace",
		"mcp__datadog__get_prs_by_head_branch",
		"mcp__datadog__get_synthetics_tests",
		"mcp__datadog__search_datadog_ci_pipeline_events",
		"mcp__datadog__search_datadog_dashboards",
		"mcp__datadog__search_datadog_docs",
		"mcp__datadog__search_datadog_events",
		"mcp__datadog__search_datadog_hosts",
		"mcp__datadog__search_datadog_incidents",
		"mcp__datadog__search_datadog_logs",
		"mcp__datadog__search_datadog_metrics",
		"mcp__datadog__search_datadog_monitors",
		"mcp__datadog__search_datadog_notebooks",
		"mcp__datadog__search_datadog_rum_events",
		"mcp__datadog__search_datadog_service_dependencies",
		"mcp__datadog__search_datadog_services",
		"mcp__datadog__search_datadog_spans",
		"mcp__datadog__search_pr_insights"
	] |
	.permissions.allow = ( .permissions.allow | unique )
'
